# Django Project Snapshot

## Project Structure
```
KemcoD365ImportApp/
  FlaskKemcoApp_20250904_140601.md
  IMPORT_EXPORT_README.md
  manage.py
  README.md
  requirements.txt
  snap.py
  d365/
    admin.py
    apps.py
    excel.py
    models.py
    resources.py
    tests.py
    urls.py
    views.py
    __init__.py
    management/
      commands/
        export_sample_data.py
        seed_refs.py
        seed_sample.py
  dynamics_search/
    admin.py
    apps.py
    models.py
    README.md
    resources.py
    tests.py
    urls.py
    views.py
    __init__.py
    management/
      __init__.py
      commands/
        export_parts_data.py
        import_parts_csv.py
        run_parts_sync.py
        seed_parts.py
        __init__.py
    templates/
      dynamics_search/
        part_detail.html
        search.html
        search_results.html
  exports/
  kemco_portal/
    asgi.py
    settings.py
    urls.py
    views.py
    wsgi.py
    __init__.py
  static/
  templates/
    home.html
    d365/
      excel_preview.html
      generate.html
      generate_heater.html
      generate_pump.html
      generate_tank.html
      index.html
      print.html
    includes/
      navbar.html
    registration/
      logged_out.html
      login.html
```

## Project-Level Files
### manage.py
```python
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'kemco_portal.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

```

### kemco_portal\settings.py
```python
"""
Django settings for kemco_portal project.

Generated by 'django-admin startproject' using Django 5.2.6.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-+!d0m!%(czf8ud7ksk11jwu+1oon$v%s=$4@vyvf2but_+zuy9'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = ['localhost', '127.0.0.1', 'testserver']


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'import_export',
    'd365',
    'dynamics_search',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'kemco_portal.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'kemco_portal.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# For PostgreSQL with full-text search (uncomment and configure when ready)
# DATABASES = {
#     'default': {
#         'ENGINE': 'django.db.backends.postgresql',
#         'NAME': 'kemco_portal',
#         'USER': 'your_db_user',
#         'PASSWORD': 'your_db_password',
#         'HOST': 'localhost',
#         'PORT': '5432',
#     }
# }


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'
STATICFILES_DIRS = [BASE_DIR / 'static']

LOGIN_URL = '/accounts/login/'
LOGIN_REDIRECT_URL = '/d365/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# Dynamics 365 Configuration
# Set these in your environment or override in local settings
DYNAMICS_COMPANY = 'yourcompany'  # Replace with your Dynamics 365 company name
DYNAMICS_CLIENT_ID = ''  # Azure AD Application (client) ID
DYNAMICS_CLIENT_SECRET = ''  # Azure AD Application secret
DYNAMICS_TENANT_ID = ''  # Azure AD Tenant ID

# Search Configuration
SEARCH_RESULTS_PER_PAGE = 20
SEARCH_MIN_QUERY_LENGTH = 2

# Import/Export Configuration
IMPORT_EXPORT_USE_TRANSACTIONS = True
IMPORT_EXPORT_SKIP_ADMIN_LOG = False
IMPORT_EXPORT_CHUNK_SIZE = 1000

```

### .venv\Lib\site-packages\django\contrib\admindocs\urls.py
```python
from django.contrib.admindocs import views
from django.urls import path, re_path

urlpatterns = [
    path(
        "",
        views.BaseAdminDocsView.as_view(template_name="admin_doc/index.html"),
        name="django-admindocs-docroot",
    ),
    path(
        "bookmarklets/",
        views.BookmarkletsView.as_view(),
        name="django-admindocs-bookmarklets",
    ),
    path(
        "tags/",
        views.TemplateTagIndexView.as_view(),
        name="django-admindocs-tags",
    ),
    path(
        "filters/",
        views.TemplateFilterIndexView.as_view(),
        name="django-admindocs-filters",
    ),
    path(
        "views/",
        views.ViewIndexView.as_view(),
        name="django-admindocs-views-index",
    ),
    path(
        "views/<view>/",
        views.ViewDetailView.as_view(),
        name="django-admindocs-views-detail",
    ),
    path(
        "models/",
        views.ModelIndexView.as_view(),
        name="django-admindocs-models-index",
    ),
    re_path(
        r"^models/(?P<app_label>[^.]+)\.(?P<model_name>[^/]+)/$",
        views.ModelDetailView.as_view(),
        name="django-admindocs-models-detail",
    ),
    path(
        "templates/<path:template>/",
        views.TemplateDetailView.as_view(),
        name="django-admindocs-templates",
    ),
]

```

### .venv\Lib\site-packages\asgiref\wsgi.py
```python
from io import BytesIO
from tempfile import SpooledTemporaryFile

from asgiref.sync import AsyncToSync, sync_to_async


class WsgiToAsgi:
    """
    Wraps a WSGI application to make it into an ASGI application.
    """

    def __init__(self, wsgi_application):
        self.wsgi_application = wsgi_application

    async def __call__(self, scope, receive, send):
        """
        ASGI application instantiation point.
        We return a new WsgiToAsgiInstance here with the WSGI app
        and the scope, ready to respond when it is __call__ed.
        """
        await WsgiToAsgiInstance(self.wsgi_application)(scope, receive, send)


class WsgiToAsgiInstance:
    """
    Per-socket instance of a wrapped WSGI application
    """

    def __init__(self, wsgi_application):
        self.wsgi_application = wsgi_application
        self.response_started = False
        self.response_content_length = None

    async def __call__(self, scope, receive, send):
        if scope["type"] != "http":
            raise ValueError("WSGI wrapper received a non-HTTP scope")
        self.scope = scope
        with SpooledTemporaryFile(max_size=65536) as body:
            # Alright, wait for the http.request messages
            while True:
                message = await receive()
                if message["type"] != "http.request":
                    raise ValueError("WSGI wrapper received a non-HTTP-request message")
                body.write(message.get("body", b""))
                if not message.get("more_body"):
                    break
            body.seek(0)
            # Wrap send so it can be called from the subthread
            self.sync_send = AsyncToSync(send)
            # Call the WSGI app
            await self.run_wsgi_app(body)

    def build_environ(self, scope, body):
        """
        Builds a scope and request body into a WSGI environ object.
        """
        script_name = scope.get("root_path", "").encode("utf8").decode("latin1")
        path_info = scope["path"].encode("utf8").decode("latin1")
        if path_info.startswith(script_name):
            path_info = path_info[len(script_name) :]
        environ = {
            "REQUEST_METHOD": scope["method"],
            "SCRIPT_NAME": script_name,
            "PATH_INFO": path_info,
            "QUERY_STRING": scope["query_string"].decode("ascii"),
            "SERVER_PROTOCOL": "HTTP/%s" % scope["http_version"],
            "wsgi.version": (1, 0),
            "wsgi.url_scheme": scope.get("scheme", "http"),
            "wsgi.input": body,
            "wsgi.errors": BytesIO(),
            "wsgi.multithread": True,
            "wsgi.multiprocess": True,
            "wsgi.run_once": False,
        }
        # Get server name and port - required in WSGI, not in ASGI
        if "server" in scope:
            environ["SERVER_NAME"] = scope["server"][0]
            environ["SERVER_PORT"] = str(scope["server"][1])
        else:
            environ["SERVER_NAME"] = "localhost"
            environ["SERVER_PORT"] = "80"

        if scope.get("client") is not None:
            environ["REMOTE_ADDR"] = scope["client"][0]

        # Go through headers and make them into environ entries
        for name, value in self.scope.get("headers", []):
            name = name.decode("latin1")
            if name == "content-length":
                corrected_name = "CONTENT_LENGTH"
            elif name == "content-type":
                corrected_name = "CONTENT_TYPE"
            else:
                corrected_name = "HTTP_%s" % name.upper().replace("-", "_")
            # HTTPbis say only ASCII chars are allowed in headers, but we latin1 just in case
            value = value.decode("latin1")
            if corrected_name in environ:
                value = environ[corrected_name] + "," + value
            environ[corrected_name] = value
        return environ

    def start_response(self, status, response_headers, exc_info=None):
        """
        WSGI start_response callable.
        """
        # Don't allow re-calling once response has begun
        if self.response_started:
            raise exc_info[1].with_traceback(exc_info[2])
        # Don't allow re-calling without exc_info
        if hasattr(self, "response_start") and exc_info is None:
            raise ValueError(
                "You cannot call start_response a second time without exc_info"
            )
        # Extract status code
        status_code, _ = status.split(" ", 1)
        status_code = int(status_code)
        # Extract headers
        headers = [
            (name.lower().encode("ascii"), value.encode("ascii"))
            for name, value in response_headers
        ]
        # Extract content-length
        self.response_content_length = None
        for name, value in response_headers:
            if name.lower() == "content-length":
                self.response_content_length = int(value)
        # Build and send response start message.
        self.response_start = {
            "type": "http.response.start",
            "status": status_code,
            "headers": headers,
        }

    @sync_to_async
    def run_wsgi_app(self, body):
        """
        Called in a subthread to run the WSGI app. We encapsulate like
        this so that the start_response callable is called in the same thread.
        """
        # Translate the scope and incoming request body into a WSGI environ
        environ = self.build_environ(self.scope, body)
        # Run the WSGI app
        bytes_sent = 0
        for output in self.wsgi_application(environ, self.start_response):
            # If this is the first response, include the response headers
            if not self.response_started:
                self.response_started = True
                self.sync_send(self.response_start)
            # If the application supplies a Content-Length header
            if self.response_content_length is not None:
                # The server should not transmit more bytes to the client than the header allows
                bytes_allowed = self.response_content_length - bytes_sent
                if len(output) > bytes_allowed:
                    output = output[:bytes_allowed]
            self.sync_send(
                {"type": "http.response.body", "body": output, "more_body": True}
            )
            bytes_sent += len(output)
            # The server should stop iterating over the response when enough data has been sent
            if bytes_sent == self.response_content_length:
                break
        # Close connection
        if not self.response_started:
            self.response_started = True
            self.sync_send(self.response_start)
        self.sync_send({"type": "http.response.body"})

```

### .venv\Lib\site-packages\django\core\asgi.py
```python
import django
from django.core.handlers.asgi import ASGIHandler


def get_asgi_application():
    """
    The public interface to Django's ASGI support. Return an ASGI 3 callable.

    Avoids making django.core.handlers.ASGIHandler a public API, in case the
    internal implementation changes or moves in the future.
    """
    django.setup(set_prefix=False)
    return ASGIHandler()

```

### requirements.txt
```python
# Core Django dependencies (already installed)
Django>=5.2.0

# Additional dependencies for dynamics_search app
requests>=2.31.0
pandas>=2.0.0

# For PostgreSQL full-text search (optional)
# psycopg2-binary>=2.9.0
# django.contrib.postgres

# For HTMX (included via CDN in templates)
# htmx.org

```

## Apps
### App: d365
### d365\models.py
```python
from django.db import models
from django.utils import timezone


class D365Job(models.Model):
    job_number = models.CharField(max_length=64, unique=True)
    job_name = models.CharField(max_length=255, blank=True, null=True)
    created_at = models.DateTimeField(default=timezone.now)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self) -> str:
        return f"{self.job_number} - {self.job_name or ''}".strip()


class D365Heater(models.Model):
    job_number = models.CharField(max_length=64)
    dash_number = models.CharField(max_length=32, blank=True, null=True)

    heater_diameter = models.IntegerField()
    heater_height = models.FloatField()
    stack_diameter = models.IntegerField()
    stack_height = models.FloatField(blank=True, null=True)

    flange_inlet = models.FloatField()
    heater_model = models.CharField(max_length=32)
    material = models.CharField(max_length=32)

    gas_train_size = models.FloatField()
    gas_train_mount = models.CharField(max_length=8)

    btu = models.FloatField()
    hand = models.CharField(max_length=16)

    heater_ab = models.CharField(max_length=8)
    heater_single_dual = models.CharField(max_length=8)

    created_at = models.DateTimeField(default=timezone.now)

    def generate_items(self, stack_height: float | None = None) -> list[dict]:
        items: list[dict] = []
        job = self.job_number
        dash = self.dash_number or ''
        stack_h = stack_height if stack_height is not None else self.heater_height

        def line(item_number: str, description: str, bom: str, template: str, product_type: str) -> dict:
            return {
                'item_number': item_number,
                'description': description,
                'bom': bom,
                'template': template,
                'product_type': product_type,
            }

        items.append(line(
            f"{job}-HEAT-{dash}",
            f"Heater Main Assembly {self.heater_model} {self.material}",
            "HEATER-MAIN",
            "HEATER-TEMPLATE",
            "Finished Good",
        ))
        items.append(line(
            f"{job}-HEAT-WELD-{dash}",
            f"Heater Weld Assembly {self.heater_diameter}x{self.heater_height}",
            "HEATER-WELD",
            "HEATER-WELD-TEMPLATE",
            "Subassembly",
        ))
        items.append(line(
            f"{job}-SHELL-{dash}",
            f"Shell {self.material} {self.heater_diameter} DIA",
            "SHELL",
            "SHELL-TEMPLATE",
            "Raw Material",
        ))
        items.append(line(
            f"{job}-STACK-{dash}",
            f"Stack {self.material} {self.stack_diameter} DIA x {stack_h}",
            "STACK",
            "STACK-TEMPLATE",
            "Subassembly",
        ))
        items.append(line(
            f"{job}-GASTRAIN-{dash}",
            f"Gas Train {self.gas_train_mount} {self.gas_train_size} in",
            "GAS-TRAIN",
            "GAS-TRAIN-TEMPLATE",
            "Purchased",
        ))
        items.append(line(
            f"{job}-MODPIPING-{dash}",
            f"Mod Piping {self.flange_inlet} in",
            "MOD-PIPING",
            "MOD-PIPING-TEMPLATE",
            "Subassembly",
        ))
        items.append(line(
            f"{job}-PRECUT-{dash}",
            f"Precut Plate for Heater",
            "PRECUT",
            "PRECUT-TEMPLATE",
            "Raw Material",
        ))
        return items


class D365Tank(models.Model):
    job_number = models.CharField(max_length=64)
    dash_number = models.CharField(max_length=32, blank=True, null=True)

    tank_diameter = models.IntegerField()
    tank_height = models.IntegerField()
    tank_inches = models.FloatField()

    material = models.CharField(max_length=32)
    tank_type = models.CharField(max_length=16)

    created_at = models.DateTimeField(default=timezone.now)

    def generate_items(self) -> list[dict]:
        job = self.job_number
        dash = self.dash_number or ''
        return [
            {
                'item_number': f"{job}-TANK-{dash}",
                'description': f"Tank {self.material} {self.tank_diameter} DIA x {self.tank_height} ft",
                'bom': 'TANK-MAIN',
                'template': 'TANK-TEMPLATE',
                'product_type': 'Finished Good',
            },
            {
                'item_number': f"{job}-TANK-SHELL-{dash}",
                'description': f"Tank Shell {self.material} {self.tank_diameter} DIA",
                'bom': 'TANK-SHELL',
                'template': 'TANK-SHELL-TEMPLATE',
                'product_type': 'Raw Material',
            },
            {
                'item_number': f"{job}-TANK-PRECUT-{dash}",
                'description': "Precut Plate for Tank",
                'bom': 'PRECUT',
                'template': 'PRECUT-TEMPLATE',
                'product_type': 'Raw Material',
            },
        ]


class D365Pump(models.Model):
    job_number = models.CharField(max_length=64)
    dash_number = models.CharField(max_length=32, blank=True, null=True)

    pump_type = models.CharField(max_length=16)
    pump_pressure = models.CharField(max_length=8)
    system_type = models.CharField(max_length=8)

    hp = models.FloatField()
    material = models.CharField(max_length=32)

    skid_length = models.FloatField()
    skid_width = models.FloatField()
    skid_height = models.FloatField()

    created_at = models.DateTimeField(default=timezone.now)

    def generate_items(self) -> list[dict]:
        job = self.job_number
        dash = self.dash_number or ''
        thickness_map = {
            'SIMPLEX': 0.25,
            'DUPLEX': 0.375,
            'TRIPLEX': 0.5,
            'QUADPLEX': 0.5,
        }
        precut_thickness = thickness_map.get(self.pump_type.upper(), 0.25)
        return [
            {
                'item_number': f"{job}-PUMP-{dash}",
                'description': f"Pump {self.pump_type} {self.hp} HP {self.material}",
                'bom': 'PUMP-MAIN',
                'template': 'PUMP-TEMPLATE',
                'product_type': 'Finished Good',
            },
            {
                'item_number': f"{job}-SKID-{dash}",
                'description': f"Skid {self.skid_length}x{self.skid_width}x{self.skid_height}",
                'bom': 'SKID',
                'template': 'SKID-TEMPLATE',
                'product_type': 'Subassembly',
            },
            {
                'item_number': f"{job}-PRECUT-{dash}",
                'description': f"Precut Plate {precut_thickness} in",
                'bom': 'PRECUT',
                'template': 'PRECUT-TEMPLATE',
                'product_type': 'Raw Material',
            },
        ]


class D365StackEconomizer(models.Model):
    job_number = models.CharField(max_length=64)
    dash_number = models.CharField(max_length=32, blank=True, null=True)
    diameter = models.IntegerField()
    height = models.IntegerField()
    material = models.CharField(max_length=32)
    created_at = models.DateTimeField(default=timezone.now)

    def generate_items(self) -> list[dict]:
        job = self.job_number
        dash = self.dash_number or ''
        return [
            {
                'item_number': f"{job}-ECON-{dash}",
                'description': f"Economizer {self.material} {self.diameter} DIA x {self.height}",
                'bom': 'ECON-MAIN',
                'template': 'ECON-TEMPLATE',
                'product_type': 'Finished Good',
            }
        ]


# Reference tables (from Excel Table Data Ref)

class HeaterMaterial(models.Model):
    code = models.CharField(max_length=32, unique=True)
    display_name = models.CharField(max_length=64)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class HeaterDiameter(models.Model):
    diameter_inch = models.IntegerField(unique=True)

    class Meta:
        ordering = ['diameter_inch']

    def __str__(self) -> str:
        return f"{self.diameter_inch}"


class HeaterHeight(models.Model):
    height_ft = models.FloatField(unique=True)

    class Meta:
        ordering = ['height_ft']

    def __str__(self) -> str:
        return f"{self.height_ft}"


class StackDiameter(models.Model):
    diameter_inch = models.IntegerField(unique=True)

    class Meta:
        ordering = ['diameter_inch']

    def __str__(self) -> str:
        return f"{self.diameter_inch}"


class StackHeight(models.Model):
    height_ft = models.FloatField(unique=True)

    class Meta:
        ordering = ['height_ft']

    def __str__(self) -> str:
        return f"{self.height_ft}"


class FlangeInlet(models.Model):
    size_inch = models.FloatField(unique=True)

    class Meta:
        ordering = ['size_inch']

    def __str__(self) -> str:
        return f"{self.size_inch}"


class HeaterModelRef(models.Model):
    code = models.CharField(max_length=32, unique=True)
    display_name = models.CharField(max_length=64)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class GasTrainSize(models.Model):
    size_inch = models.FloatField(unique=True)

    class Meta:
        ordering = ['size_inch']

    def __str__(self) -> str:
        return f"{self.size_inch}"


class GasTrainMount(models.Model):
    code = models.CharField(max_length=8, unique=True)
    display_name = models.CharField(max_length=32)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class BTURating(models.Model):
    value_mmbtu = models.FloatField(unique=True)

    class Meta:
        ordering = ['value_mmbtu']

    def __str__(self) -> str:
        return f"{self.value_mmbtu}"


class HeaterHandRef(models.Model):
    code = models.CharField(max_length=16, unique=True)
    display_name = models.CharField(max_length=32)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class TankMaterial(models.Model):
    code = models.CharField(max_length=32, unique=True)
    display_name = models.CharField(max_length=64)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class HeaterABRef(models.Model):
    code = models.CharField(max_length=8, unique=True)
    display_name = models.CharField(max_length=16)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class TankDiameter(models.Model):
    diameter_inch = models.IntegerField(unique=True)

    class Meta:
        ordering = ['diameter_inch']

    def __str__(self) -> str:
        return f"{self.diameter_inch}"


class TankHeight(models.Model):
    height_ft = models.IntegerField(unique=True)

    class Meta:
        ordering = ['height_ft']

    def __str__(self) -> str:
        return f"{self.height_ft}"


class TankHeightInches(models.Model):
    height_ft = models.IntegerField(unique=True)
    inches = models.FloatField()

    class Meta:
        ordering = ['height_ft']

    def __str__(self) -> str:
        return f"{self.height_ft} ft -> {self.inches} in"


class TankType(models.Model):
    code = models.CharField(max_length=16, unique=True)
    display_name = models.CharField(max_length=32)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class PumpMaterial(models.Model):
    code = models.CharField(max_length=32, unique=True)
    display_name = models.CharField(max_length=64)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class PumpTypeRef(models.Model):
    code = models.CharField(max_length=16, unique=True)
    display_name = models.CharField(max_length=32)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class PumpPressure(models.Model):
    code = models.CharField(max_length=8, unique=True)
    display_name = models.CharField(max_length=32)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class SystemType(models.Model):
    code = models.CharField(max_length=8, unique=True)
    display_name = models.CharField(max_length=32)

    class Meta:
        ordering = ['code']

    def __str__(self) -> str:
        return self.display_name


class Horsepower(models.Model):
    hp = models.FloatField(unique=True)

    class Meta:
        ordering = ['hp']

    def __str__(self) -> str:
        return f"{self.hp}"


class D365GeneratedItem(models.Model):
    job_number = models.CharField(max_length=64)
    section = models.CharField(max_length=16)  # 'heater', 'tank', 'pump'
    item_number = models.CharField(max_length=128)
    description = models.CharField(max_length=255)
    bom = models.CharField(max_length=64)
    template = models.CharField(max_length=64)
    product_type = models.CharField(max_length=64)
    created_at = models.DateTimeField(default=timezone.now)
    
    class Meta:
        ordering = ['job_number', 'section', 'item_number']
        unique_together = ['job_number', 'section', 'item_number']
    
    def __str__(self) -> str:
        return f"{self.job_number} - {self.section} - {self.item_number}"


# Create your models here.

```

### d365\views.py
```python
from django.shortcuts import render, get_object_or_404, redirect
from django.http import JsonResponse, HttpRequest, HttpResponse
from django.views.decorators.http import require_http_methods
from django.contrib.auth.decorators import login_required
from .models import (
    D365Job, D365Heater, D365Tank, D365Pump, D365GeneratedItem,
    HeaterMaterial, HeaterDiameter, HeaterHeight, StackDiameter, StackHeight,
    FlangeInlet, HeaterModelRef, GasTrainSize, GasTrainMount, BTURating,
    HeaterHandRef, HeaterABRef,
    TankMaterial, TankDiameter, TankHeight, TankHeightInches, TankType,
    PumpMaterial, PumpTypeRef, PumpPressure, SystemType, Horsepower,
)
from .excel import read_workbook_outputs
from pathlib import Path


def save_generated_items(job_number: str, section: str, items: list[dict]):
    """Save generated items to database, replacing existing ones for this job/section"""
    # Delete existing items for this job/section
    D365GeneratedItem.objects.filter(job_number=job_number, section=section).delete()
    
    # Save new items
    for item in items:
        D365GeneratedItem.objects.create(
            job_number=job_number,
            section=section,
            item_number=item['item_number'],
            description=item['description'],
            bom=item['bom'],
            template=item['template'],
            product_type=item['product_type']
        )


def load_generated_items(job_number: str) -> dict:
    """Load generated items for a job, organized by section"""
    items = D365GeneratedItem.objects.filter(job_number=job_number)
    result = {'heater_items': [], 'tank_items': [], 'pump_items': []}
    
    for item in items:
        section_items = result.get(f'{item.section}_items', [])
        section_items.append({
            'item_number': item.item_number,
            'description': item.description,
            'bom': item.bom,
            'template': item.template,
            'product_type': item.product_type
        })
        result[f'{item.section}_items'] = section_items
    
    return result


@login_required
def d365_home(request: HttpRequest) -> HttpResponse:
    jobs = D365Job.objects.order_by('-updated_at')[:50]
    return render(request, 'd365/index.html', {
        'jobs': jobs,
    })


@login_required
@require_http_methods(["GET", "POST"])
def generate_all(request: HttpRequest) -> HttpResponse:
    jobs = D365Job.objects.order_by('-updated_at')[:50]

    ref = {
        'heater_materials': HeaterMaterial.objects.all(),
        'heater_diameters': HeaterDiameter.objects.all(),
        'heater_heights': HeaterHeight.objects.all(),
        'stack_diameters': StackDiameter.objects.all(),
        'stack_heights': StackHeight.objects.all(),
        'flange_inlets': FlangeInlet.objects.all(),
        'heater_models': HeaterModelRef.objects.all(),
        'gas_train_sizes': GasTrainSize.objects.all(),
        'gas_train_mounts': GasTrainMount.objects.all(),
        'btu_ratings': BTURating.objects.all(),
        'heater_hands': HeaterHandRef.objects.all(),
        'heater_ab_list': HeaterABRef.objects.all(),

        'tank_materials': TankMaterial.objects.all(),
        'tank_diameters': TankDiameter.objects.all(),
        'tank_heights': TankHeight.objects.all(),
        'tank_types': TankType.objects.all(),

        'pump_materials': PumpMaterial.objects.all(),
        'pump_types': PumpTypeRef.objects.all(),
        'pump_pressures': PumpPressure.objects.all(),
        'system_types': SystemType.objects.all(),
        'horsepower': Horsepower.objects.all(),
    }

    context: dict = {'jobs': jobs, **ref}

    # Prefill from query param (?job=JOB)
    if request.method == 'GET':
        job_q = request.GET.get('job')
        if job_q:
            job = D365Job.objects.filter(job_number=job_q).first()
            context['job_number'] = job_q
            context['job_name'] = job.job_name if job else ''
            heater = D365Heater.objects.filter(job_number=job_q).order_by('-created_at').first()
            tank = D365Tank.objects.filter(job_number=job_q).order_by('-created_at').first()
            pump = D365Pump.objects.filter(job_number=job_q).order_by('-created_at').first()
            context['heater_initial'] = heater if heater else None
            context['tank_initial'] = tank if tank else None
            context['pump_initial'] = pump if pump else None
            context['heater_dash_value'] = (heater.dash_number if heater and heater.dash_number else '01')
            context['tank_dash_value'] = (tank.dash_number if tank and tank.dash_number else '01')
            context['pump_dash_value'] = (pump.dash_number if pump and pump.dash_number else '01')
        
        # Get selected sections from session or default to all
        selected_sections = request.session.get('selected_sections', ['heater', 'tank', 'pump'])
        context['selected_sections'] = selected_sections
        
        # Load existing generated items if job is specified
        if job_q:
            generated_items = load_generated_items(job_q)
            context.update(generated_items)

    if request.method == 'POST':
        job_number = request.POST.get('job_number', '').strip()
        job_name = request.POST.get('job_name', '').strip() or None
        
        # Validate required fields
        if not job_number:
            context['error'] = 'Job Number is required'
            return render(request, 'd365/generate.html', context)
        if not job_name:
            context['error'] = 'Job Name is required'
            return render(request, 'd365/generate.html', context)
        
        if job_number:
            D365Job.objects.update_or_create(job_number=job_number, defaults={'job_name': job_name})
        
        # Handle selected sections for generate_selected
        if request.POST.get('generate_selected'):
            selected_sections = request.POST.get('selected_sections', '').split(',')
            request.session['selected_sections'] = selected_sections
            context['selected_sections'] = selected_sections

        def to_int(name: str):
            val = request.POST.get(name)
            try:
                return int(val) if val not in (None, '') else None
            except (TypeError, ValueError):
                return None

        def to_float(name: str):
            val = request.POST.get(name)
            try:
                return float(val) if val not in (None, '') else None
            except (TypeError, ValueError):
                return None

        # Heater
        if request.POST.get('heater_submit') == '1' or request.POST.get('generate_all') == '1':
            hd = to_int('heater_diameter')
            hh = to_float('heater_height')
            sd = to_int('stack_diameter')
            fi = to_float('flange_inlet')
            gts = to_float('gas_train_size')
            btu = to_float('btu')
            model = request.POST.get('heater_model')
            material = request.POST.get('heater_material')
            mount = request.POST.get('gas_train_mount')
            hand = request.POST.get('heater_hand')
            if None not in (hd, hh, sd, fi, gts, btu) and all([model, material, mount, hand]):
                heater_dash = request.POST.get('heater_dash_number') or None
                stack_height = to_float('stack_height')
                heater = D365Heater.objects.create(
                    job_number=job_number,
                    dash_number=heater_dash,
                    heater_diameter=hd,
                    heater_height=hh,
                    stack_diameter=sd,
                    stack_height=stack_height,
                    flange_inlet=fi,
                    heater_model=model,
                    material=material,
                    gas_train_size=gts,
                    gas_train_mount=mount,
                    btu=btu,
                    hand=hand,
                    heater_ab=(request.POST.get('heater_ab') or ''),
                    heater_single_dual=(request.POST.get('heater_single_dual') or 'S'),
                )
                heater_items = _format_items(
                    job_number,
                    heater.dash_number or '01',
                    _build_heater_rows(heater, heater.stack_height),
                )
                context['heater_items'] = heater_items
                context['heater_initial'] = heater
                context['heater_dash_value'] = heater_dash or (heater.dash_number or '01')
                
                # Save generated items
                save_generated_items(job_number, 'heater', heater_items)

        # Tank
        if request.POST.get('tank_submit') == '1' or request.POST.get('generate_all') == '1':
            td = to_int('tank_diameter')
            th = to_int('tank_height')
            material = request.POST.get('tank_material')
            ttype = request.POST.get('tank_type')
            if None not in (td, th) and all([material, ttype]):
                ti = TankHeightInches.objects.filter(height_ft=th).first()
                tank_inches = float(ti.inches) if ti else 0.0
                tank_dash = request.POST.get('tank_dash_number') or None
                tank = D365Tank.objects.create(
                    job_number=job_number,
                    dash_number=tank_dash,
                    tank_diameter=td,
                    tank_height=th,
                    tank_inches=tank_inches,
                    material=material,
                    tank_type=ttype,
                )
                tank_items = _format_items(
                    job_number,
                    tank.dash_number or '01',
                    _build_tank_rows(tank),
                )
                context['tank_items'] = tank_items
                context['tank_initial'] = tank
                context['tank_dash_value'] = tank_dash or (tank.dash_number or '01')
                
                # Save generated items
                save_generated_items(job_number, 'tank', tank_items)

        # Pump
        if request.POST.get('pump_submit') == '1' or request.POST.get('generate_all') == '1':
            ptype = request.POST.get('pump_type')
            ppress = request.POST.get('pump_pressure')
            stype = request.POST.get('system_type')
            hp = to_float('hp')
            material = request.POST.get('pump_material')
            sl = to_float('skid_length')
            sw = to_float('skid_width')
            sh = to_float('skid_height')
            if None not in (hp, sl, sw, sh) and all([ptype, ppress, stype, material]):
                pump_dash = request.POST.get('pump_dash_number') or None
                pump = D365Pump.objects.create(
                    job_number=job_number,
                    dash_number=pump_dash,
                    pump_type=ptype,
                    pump_pressure=ppress,
                    system_type=stype,
                    hp=hp,
                    material=material,
                    skid_length=sl,
                    skid_width=sw,
                    skid_height=sh,
                )
                pump_items = _format_items(
                    job_number,
                    pump.dash_number or '01',
                    _build_pump_rows(pump),
                )
                context['pump_items'] = pump_items
                context['pump_initial'] = pump
                context['pump_dash_value'] = pump_dash or (pump.dash_number or '01')
                
                # Save generated items
                save_generated_items(job_number, 'pump', pump_items)

        context['job_number'] = job_number
        context['job_name'] = job_name
        
        # Redirect to the new job URL to show the generated items
        return redirect(f'/d365/generate-all/?job={job_number}')

    return render(request, 'd365/generate.html', context)


@login_required
def generate_selected(request: HttpRequest) -> HttpResponse:
    """Generate items for selected sections only"""
    jobs = D365Job.objects.order_by('-updated_at')[:50]
    selected_sections = request.POST.get('selected_sections', '').split(',')
    
    ref = {
        'heater_materials': HeaterMaterial.objects.all(),
        'heater_diameters': HeaterDiameter.objects.all(),
        'heater_heights': HeaterHeight.objects.all(),
        'stack_diameters': StackDiameter.objects.all(),
        'stack_heights': StackHeight.objects.all(),
        'flange_inlets': FlangeInlet.objects.all(),
        'heater_models': HeaterModelRef.objects.all(),
        'gas_train_sizes': GasTrainSize.objects.all(),
        'gas_train_mounts': GasTrainMount.objects.all(),
        'btu_ratings': BTURating.objects.all(),
        'heater_hands': HeaterHandRef.objects.all(),
        'heater_ab_list': HeaterABRef.objects.all(),

        'tank_materials': TankMaterial.objects.all(),
        'tank_diameters': TankDiameter.objects.all(),
        'tank_heights': TankHeight.objects.all(),
        'tank_types': TankType.objects.all(),

        'pump_materials': PumpMaterial.objects.all(),
        'pump_types': PumpTypeRef.objects.all(),
        'pump_pressures': PumpPressure.objects.all(),
        'system_types': SystemType.objects.all(),
        'horsepower': Horsepower.objects.all(),
    }

    context: dict = {'jobs': jobs, **ref, 'selected_sections': selected_sections}
    
    # Load existing generated items if job is specified
    job_q = request.GET.get('job')
    if job_q:
        generated_items = load_generated_items(job_q)
        context.update(generated_items)

    if request.method == 'POST':
        job_number = request.POST.get('job_number', '').strip()
        job_name = request.POST.get('job_name', '').strip() or None
        
        # Validate required fields
        if not job_number:
            context['error'] = 'Job Number is required'
            return render(request, 'd365/generate.html', context)
        if not job_name:
            context['error'] = 'Job Name is required'
            return render(request, 'd365/generate.html', context)
        
        if job_number:
            D365Job.objects.update_or_create(job_number=job_number, defaults={'job_name': job_name})

        def to_int(name: str):
            val = request.POST.get(name)
            try:
                return int(val) if val not in (None, '') else None
            except (TypeError, ValueError):
                return None

        def to_float(name: str):
            val = request.POST.get(name)
            try:
                return float(val) if val not in (None, '') else None
            except (TypeError, ValueError):
                return None

        # Process only selected sections
        if 'heater' in selected_sections and (request.POST.get('heater_submit') == '1' or request.POST.get('generate_selected') == '1'):
            hd = to_int('heater_diameter')
            hh = to_float('heater_height')
            sd = to_int('stack_diameter')
            fi = to_float('flange_inlet')
            gts = to_float('gas_train_size')
            btu = to_float('btu')
            model = request.POST.get('heater_model')
            material = request.POST.get('heater_material')
            mount = request.POST.get('gas_train_mount')
            hand = request.POST.get('heater_hand')
            if None not in (hd, hh, sd, fi, gts, btu) and all([model, material, mount, hand]):
                heater_dash = request.POST.get('heater_dash_number') or None
                stack_height = to_float('stack_height')
                heater = D365Heater.objects.create(
                    job_number=job_number,
                    dash_number=heater_dash,
                    heater_diameter=hd,
                    heater_height=hh,
                    stack_diameter=sd,
                    stack_height=stack_height,
                    flange_inlet=fi,
                    heater_model=model,
                    material=material,
                    gas_train_size=gts,
                    gas_train_mount=mount,
                    btu=btu,
                    hand=hand,
                    heater_ab=(request.POST.get('heater_ab') or ''),
                    heater_single_dual=(request.POST.get('heater_single_dual') or 'S'),
                )
                heater_items = _format_items(
                    job_number, heater_dash or '01', _build_heater_rows(heater, heater.stack_height)
                )
                context['heater_items'] = heater_items
                context['heater_initial'] = heater
                context['heater_dash_value'] = heater_dash or '01'
                
                # Save generated items
                save_generated_items(job_number, 'heater', heater_items)

        if 'tank' in selected_sections and (request.POST.get('tank_submit') == '1' or request.POST.get('generate_selected') == '1'):
            td = to_int('tank_diameter')
            th = to_int('tank_height')
            ti = to_float('tank_inches')
            material = request.POST.get('tank_material')
            tank_type = request.POST.get('tank_type')
            if None not in (td, th, ti) and all([material, tank_type]):
                tank_dash = request.POST.get('tank_dash_number') or None
                tank = D365Tank.objects.create(
                    job_number=job_number,
                    dash_number=tank_dash,
                    tank_diameter=td,
                    tank_height=th,
                    tank_inches=ti,
                    material=material,
                    tank_type=tank_type,
                )
                tank_items = _format_items(job_number, tank_dash or '01', _build_tank_rows(tank))
                context['tank_items'] = tank_items
                context['tank_initial'] = tank
                context['tank_dash_value'] = tank_dash or '01'
                
                # Save generated items
                save_generated_items(job_number, 'tank', tank_items)

        if 'pump' in selected_sections and (request.POST.get('pump_submit') == '1' or request.POST.get('generate_selected') == '1'):
            pump_type = request.POST.get('pump_type')
            pump_pressure = request.POST.get('pump_pressure')
            system_type = request.POST.get('system_type')
            hp = to_float('hp')
            material = request.POST.get('pump_material')
            sl = to_float('skid_length')
            sw = to_float('skid_width')
            sh = to_float('skid_height')
            if all([pump_type, pump_pressure, system_type, hp, material, sl, sw, sh]):
                pump_dash = request.POST.get('pump_dash_number') or None
                pump = D365Pump.objects.create(
                    job_number=job_number,
                    dash_number=pump_dash,
                    pump_type=pump_type,
                    pump_pressure=pump_pressure,
                    system_type=system_type,
                    hp=hp,
                    material=material,
                    skid_length=sl,
                    skid_width=sw,
                    skid_height=sh,
                )
                pump_items = _format_items(job_number, pump_dash or '01', _build_pump_rows(pump))
                context['pump_items'] = pump_items
                context['pump_initial'] = pump
                context['pump_dash_value'] = pump_dash or '01'
                
                # Save generated items
                save_generated_items(job_number, 'pump', pump_items)

        context['job_number'] = job_number
        context['job_name'] = job_name
        
        # Redirect to the new job URL to show the generated items
        return redirect(f'/d365/generate-all/?job={job_number}')

    return render(request, 'd365/generate.html', context)


@login_required
def save_selection(request: HttpRequest) -> JsonResponse:
    """Save selected sections to session"""
    if request.method == 'POST':
        import json
        data = json.loads(request.body)
        selected_sections = data.get('selected_sections', [])
        request.session['selected_sections'] = selected_sections
        return JsonResponse({'success': True})
    return JsonResponse({'success': False})


@login_required
def generate_heater(request: HttpRequest) -> HttpResponse:
    """Generate only heater items"""
    return generate_section(request, 'heater')

@login_required
def generate_tank(request: HttpRequest) -> HttpResponse:
    """Generate only tank items"""
    return generate_section(request, 'tank')

@login_required
def generate_pump(request: HttpRequest) -> HttpResponse:
    """Generate only pump items"""
    return generate_section(request, 'pump')

def generate_section(request: HttpRequest, section: str) -> HttpResponse:
    """Helper function to generate items for a specific section"""
    jobs = D365Job.objects.order_by('-updated_at')[:50]
    
    ref = {
        'heater_materials': HeaterMaterial.objects.all(),
        'heater_diameters': HeaterDiameter.objects.all(),
        'heater_heights': HeaterHeight.objects.all(),
        'stack_diameters': StackDiameter.objects.all(),
        'stack_heights': StackHeight.objects.all(),
        'flange_inlets': FlangeInlet.objects.all(),
        'heater_models': HeaterModelRef.objects.all(),
        'gas_train_sizes': GasTrainSize.objects.all(),
        'gas_train_mounts': GasTrainMount.objects.all(),
        'btu_ratings': BTURating.objects.all(),
        'heater_hands': HeaterHandRef.objects.all(),
        'heater_ab_list': HeaterABRef.objects.all(),

        'tank_materials': TankMaterial.objects.all(),
        'tank_diameters': TankDiameter.objects.all(),
        'tank_heights': TankHeight.objects.all(),
        'tank_types': TankType.objects.all(),

        'pump_materials': PumpMaterial.objects.all(),
        'pump_types': PumpTypeRef.objects.all(),
        'pump_pressures': PumpPressure.objects.all(),
        'system_types': SystemType.objects.all(),
        'horsepower': Horsepower.objects.all(),
    }

    context: dict = {'jobs': jobs, **ref, 'current_section': section}

    # Handle GET request - load existing job data
    if request.method == 'GET':
        job_q = request.GET.get('job')
        if job_q:
            job = D365Job.objects.filter(job_number=job_q).first()
            context['job_number'] = job_q
            context['job_name'] = job.job_name if job else ''
            
            if section == 'heater':
                heater = D365Heater.objects.filter(job_number=job_q).order_by('-created_at').first()
                context['heater_initial'] = heater if heater else None
                context['heater_dash_value'] = (heater.dash_number if heater and heater.dash_number else '01')
            elif section == 'tank':
                tank = D365Tank.objects.filter(job_number=job_q).order_by('-created_at').first()
                context['tank_initial'] = tank if tank else None
                context['tank_dash_value'] = (tank.dash_number if tank and tank.dash_number else '01')
            elif section == 'pump':
                pump = D365Pump.objects.filter(job_number=job_q).order_by('-created_at').first()
                context['pump_initial'] = pump if pump else None
                context['pump_dash_value'] = (pump.dash_number if pump and pump.dash_number else '01')

    if request.method == 'POST':
        job_number = request.POST.get('job_number', '').strip()
        job_name = request.POST.get('job_name', '').strip() or None
        if job_number:
            D365Job.objects.update_or_create(job_number=job_number, defaults={'job_name': job_name})

        def to_int(name: str):
            val = request.POST.get(name)
            try:
                return int(val) if val not in (None, '') else None
            except (TypeError, ValueError):
                return None

        def to_float(name: str):
            val = request.POST.get(name)
            try:
                return float(val) if val not in (None, '') else None
            except (TypeError, ValueError):
                return None

        # Process only the specific section
        if section == 'heater':
            hd = to_int('heater_diameter')
            hh = to_float('heater_height')
            sd = to_int('stack_diameter')
            fi = to_float('flange_inlet')
            gts = to_float('gas_train_size')
            btu = to_float('btu')
            model = request.POST.get('heater_model')
            material = request.POST.get('heater_material')
            mount = request.POST.get('gas_train_mount')
            hand = request.POST.get('heater_hand')
            if None not in (hd, hh, sd, fi, gts, btu) and all([model, material, mount, hand]):
                heater_dash = request.POST.get('heater_dash_number') or None
                stack_height = to_float('stack_height')
                heater = D365Heater.objects.create(
                    job_number=job_number,
                    dash_number=heater_dash,
                    heater_diameter=hd,
                    heater_height=hh,
                    stack_diameter=sd,
                    stack_height=stack_height,
                    flange_inlet=fi,
                    heater_model=model,
                    material=material,
                    gas_train_size=gts,
                    gas_train_mount=mount,
                    btu=btu,
                    hand=hand,
                    heater_ab=(request.POST.get('heater_ab') or ''),
                    heater_single_dual=(request.POST.get('heater_single_dual') or 'S'),
                )
                context['heater_items'] = _format_items(
                    job_number, heater_dash or '01', _build_heater_rows(heater, heater.stack_height)
                )
                context['heater_initial'] = heater
                context['heater_dash_value'] = heater_dash or '01'
            else:
                # If validation failed, preserve form data
                context['heater_initial'] = type('obj', (object,), {
                    'heater_diameter': hd,
                    'heater_height': hh,
                    'stack_diameter': sd,
                    'stack_height': to_float('stack_height'),
                    'flange_inlet': fi,
                    'heater_model': model,
                    'material': material,
                    'gas_train_size': gts,
                    'gas_train_mount': mount,
                    'btu': btu,
                    'hand': hand,
                    'heater_ab': request.POST.get('heater_ab', ''),
                    'heater_single_dual': request.POST.get('heater_single_dual', 'S'),
                    'dash_number': request.POST.get('heater_dash_number', '01')
                })()
                context['heater_dash_value'] = request.POST.get('heater_dash_number', '01')

        elif section == 'tank':
            td = to_int('tank_diameter')
            th = to_int('tank_height')
            ti = to_float('tank_inches')
            material = request.POST.get('tank_material')
            tank_type = request.POST.get('tank_type')
            if None not in (td, th, ti) and all([material, tank_type]):
                tank_dash = request.POST.get('tank_dash_number') or None
                tank = D365Tank.objects.create(
                    job_number=job_number,
                    dash_number=tank_dash,
                    tank_diameter=td,
                    tank_height=th,
                    tank_inches=ti,
                    material=material,
                    tank_type=tank_type,
                )
                context['tank_items'] = _format_items(job_number, tank_dash or '01', _build_tank_rows(tank))
                context['tank_initial'] = tank
                context['tank_dash_value'] = tank_dash or '01'
            else:
                # If validation failed, preserve form data
                context['tank_initial'] = type('obj', (object,), {
                    'tank_diameter': td,
                    'tank_height': th,
                    'tank_inches': ti,
                    'material': material,
                    'tank_type': tank_type,
                    'dash_number': request.POST.get('tank_dash_number', '01')
                })()
                context['tank_dash_value'] = request.POST.get('tank_dash_number', '01')

        elif section == 'pump':
            pump_type = request.POST.get('pump_type')
            pump_pressure = request.POST.get('pump_pressure')
            system_type = request.POST.get('system_type')
            hp = to_float('hp')
            material = request.POST.get('pump_material')
            sl = to_float('skid_length')
            sw = to_float('skid_width')
            sh = to_float('skid_height')
            if all([pump_type, pump_pressure, system_type, hp, material, sl, sw, sh]):
                pump_dash = request.POST.get('pump_dash_number') or None
                pump = D365Pump.objects.create(
                    job_number=job_number,
                    dash_number=pump_dash,
                    pump_type=pump_type,
                    pump_pressure=pump_pressure,
                    system_type=system_type,
                    hp=hp,
                    material=material,
                    skid_length=sl,
                    skid_width=sw,
                    skid_height=sh,
                )
                pump_items = _format_items(job_number, pump_dash or '01', _build_pump_rows(pump))
                context['pump_items'] = pump_items
                context['pump_initial'] = pump
                context['pump_dash_value'] = pump_dash or '01'
                
                # Save generated items
                save_generated_items(job_number, 'pump', pump_items)
            else:
                # If validation failed, preserve form data
                context['pump_initial'] = type('obj', (object,), {
                    'pump_type': pump_type,
                    'pump_pressure': pump_pressure,
                    'system_type': system_type,
                    'hp': hp,
                    'material': material,
                    'skid_length': sl,
                    'skid_width': sw,
                    'skid_height': sh,
                    'dash_number': request.POST.get('pump_dash_number', '01')
                })()
                context['pump_dash_value'] = request.POST.get('pump_dash_number', '01')

        context['job_number'] = job_number
        context['job_name'] = job_name

    # Always ensure we have selected_sections for the template
    if 'selected_sections' not in context:
        context['selected_sections'] = ['heater', 'tank', 'pump']

    return render(request, f'd365/generate_{section}.html', context)


@require_http_methods(["POST"])  # relaxed auth per spec; can add login_required later
def save_job(request: HttpRequest) -> JsonResponse:
    job_number = request.POST.get('job_number') or (request.content_type == 'application/json' and (request.json() if hasattr(request, 'json') else None))
    # Simple, robust extraction supporting form or JSON
    if isinstance(job_number, dict):
        payload = job_number
        job_number = payload.get('job_number')
        job_name = payload.get('job_name')
    else:
        job_name = request.POST.get('job_name')
    if not job_number:
        return JsonResponse({'success': False, 'message': 'job_number is required'}, status=400)
    job, created = D365Job.objects.update_or_create(
        job_number=job_number,
        defaults={
            'job_name': job_name,
        }
    )
    return JsonResponse({'success': True, 'message': 'Saved' if created else 'Updated', 'job_id': job.id})


@login_required
def load_job_by_id(request: HttpRequest, job_id: int) -> JsonResponse:
    job = get_object_or_404(D365Job, id=job_id)
    return _job_payload(job)


@login_required
def load_job_by_number(request: HttpRequest, job_number: str) -> JsonResponse:
    job = get_object_or_404(D365Job, job_number=job_number)
    return _job_payload(job)


@login_required
def jobs_list(request: HttpRequest) -> JsonResponse:
    jobs = list(D365Job.objects.order_by('-updated_at').values('id', 'job_number', 'job_name', 'updated_at'))
    return JsonResponse(jobs, safe=False)


@login_required
@require_http_methods(["POST"])
def delete_job(request: HttpRequest, job_id: int) -> HttpResponse:
    job = get_object_or_404(D365Job, id=job_id)
    # Optionally cascade delete related section rows
    D365Heater.objects.filter(job_number=job.job_number).delete()
    D365Tank.objects.filter(job_number=job.job_number).delete()
    D365Pump.objects.filter(job_number=job.job_number).delete()
    job.delete()
    return redirect('d365_home')


@login_required
def print_job(request: HttpRequest, job_number: str) -> HttpResponse:
    job = get_object_or_404(D365Job, job_number=job_number)
    heater = D365Heater.objects.filter(job_number=job_number).order_by('-created_at').first()
    tank = D365Tank.objects.filter(job_number=job_number).order_by('-created_at').first()
    pump = D365Pump.objects.filter(job_number=job_number).order_by('-created_at').first()

    # Get selected sections from query parameter
    selected_sections = request.GET.get('sections', 'heater,tank,pump').split(',')
    
    # Use the same formatting logic as the generator
    heater_items = []
    tank_items = []
    pump_items = []
    
    if 'heater' in selected_sections and heater:
        heater_items = _format_items(job_number, heater.dash_number or '01', _build_heater_rows(heater, heater.stack_height))
    
    if 'tank' in selected_sections and tank:
        tank_items = _format_items(job_number, tank.dash_number or '01', _build_tank_rows(tank))
    
    if 'pump' in selected_sections and pump:
        pump_items = _format_items(job_number, pump.dash_number or '01', _build_pump_rows(pump))

    return render(request, 'd365/print.html', {
        'job': job,
        'heater_items': heater_items,
        'tank_items': tank_items,
        'pump_items': pump_items,
        'selected_sections': selected_sections,
    })


def _job_payload(job: D365Job) -> JsonResponse:
    job_number = job.job_number
    heater = D365Heater.objects.filter(job_number=job_number).order_by('-created_at').first()
    tank = D365Tank.objects.filter(job_number=job_number).order_by('-created_at').first()
    pump = D365Pump.objects.filter(job_number=job_number).order_by('-created_at').first()

    def model_to_dict(instance):
        if not instance:
            return None
        data = {f.name: getattr(instance, f.name) for f in instance._meta.fields}
        return data

    # Use the same formatting logic as the generator
    heater_items = []
    tank_items = []
    pump_items = []
    
    if heater:
        heater_items = _format_items(job_number, heater.dash_number or '01', _build_heater_rows(heater, heater.stack_height))
    
    if tank:
        tank_items = _format_items(job_number, tank.dash_number or '01', _build_tank_rows(tank))
    
    if pump:
        pump_items = _format_items(job_number, pump.dash_number or '01', _build_pump_rows(pump))

    payload = {
        'job': {'id': job.id, 'job_number': job.job_number, 'job_name': job.job_name, 'updated_at': job.updated_at},
        'heater': model_to_dict(heater),
        'tank': model_to_dict(tank),
        'pump': model_to_dict(pump),
        'heater_items': heater_items,
        'tank_items': tank_items,
        'pump_items': pump_items,
    }
    return JsonResponse(payload)


@login_required
def excel_preview(request: HttpRequest) -> HttpResponse:
    # Path to workbook in project root as per user-provided file
    workbook_path = Path('d265_import.xlsx')
    outputs = {}
    if workbook_path.exists():
        outputs = read_workbook_outputs(workbook_path)
    return render(request, 'd365/excel_preview.html', {
        'has_file': workbook_path.exists(),
        'outputs': outputs,
    })


def _format_items(job_number: str, dash: str, items: list[dict]) -> list[dict]:
    formatted: list[dict] = []
    for seq, row in enumerate(items):
        product_type = row.get('product_type', '')
        type_map = {
            'Finished Good': 'Item',
            'Subassembly': 'Sub Assy',
            'Raw Material': 'Phantom',
            'Purchased': 'Pegged Supply',
            'Sub Assy': 'Sub Assy',
            'Item': 'Item',
            'Phantom': 'Phantom',
        }
        pt = type_map.get(product_type, product_type)

        # Excel formula: =CONCATENATE($I$2,"-",$I$3) for main items
        if seq == 0:
            item_number = f"{job_number}-{dash}"
        else:
            # Allow special override like '-A' for certain rows (e.g., Tank precut)
            suffix = row.get('override_suffix')
            if suffix:
                item_number = f"{job_number}-{dash}.1-{suffix}"
            else:
                # Excel formula: =CONCATENATE($I$2,"-",$I$3,".1") for sub-items
                item_number = f"{job_number}-{dash}.{seq}"
        
        # Excel formula: =CONCATENATE($I$2,"-",$I$3,"-000") for main items
        # Excel formula: =CONCATENATE($I$2,"-",$I$3,".1","-000") for sub-items
        bom = f"{item_number}-000"
        
        # Template logic: main items (-01) are "FGFAB", sub-items (.1, .2, etc.) are "Sub Assy"
        template = "FGFAB" if seq == 0 else "Sub Assy"

        formatted.append({
            'item_number': item_number,
            'description': row.get('description', ''),
            'bom': bom,
            'template': template,
            'product_type': pt or 'Item',
        })
    return formatted


def _fmt_dim(value: float | int) -> str:
    # Trim .0
    try:
        iv = int(value)
        if float(value) == float(iv):
            return f"{iv}"
        return f"{value}"
    except Exception:
        return str(value)


def _build_heater_rows(heater: D365Heater, stack_height: float | None) -> list[dict]:
    d = _fmt_dim(heater.heater_diameter)
    h = _fmt_dim(heater.heater_height)
    sd = _fmt_dim(heater.stack_diameter)
    sh = _fmt_dim(stack_height if stack_height is not None else heater.heater_height)
    model = (heater.heater_model or '').upper()
    material = (heater.material or '').upper()
    hand = (heater.hand or '').upper()
    mount = (heater.gas_train_mount or '').upper()
    gts = _fmt_dim(heater.gas_train_size)
    btu = _fmt_dim(heater.btu)
    ab = (heater.heater_ab or '').strip().upper()
    fi = _fmt_dim(heater.flange_inlet)

    rows: list[dict] = []
    
    # Excel formula: =IF(I14=0,CONCATENATE("HEATER, FAB, ",I4,"X",I5,", ",I8,", ",I9),CONCATENATE("HEATER ",I14,", FAB, ",I4,"X",I5,", ",I8,", ",I9))
    if not ab:
        desc0 = f"HEATER, FAB, {d}X{h}, {material}, {model}"
    else:
        desc0 = f"HEATER {ab}, FAB, {d}X{h}, {material}, {model}"
    rows.append({'description': desc0, 'product_type': 'Finished Good'})

    # Excel formula: =IF(I14=0,CONCATENATE("HEATER, WELD, ",I4,"X",I5,", ",I9),CONCATENATE("HEATER ",I14,", WELD, ",I4,"X",I5,", ",I9))
    if not ab:
        desc1 = f"HEATER, WELD, {d}X{h}, {material}"
    else:
        desc1 = f"HEATER {ab}, WELD, {d}X{h}, {material}"
    rows.append({'description': desc1, 'product_type': 'Pegged Supply'})
    
    # Excel formula: =IF(I14=0,CONCATENATE("HEATER, SHELL, ",I4,"X",I5,", ",I9),CONCATENATE("HEATER ",I14,", SHELL, ",I4,"X",I5,", ",I9))
    if not ab:
        desc2 = f"HEATER, SHELL, {d}X{h}, {material}"
    else:
        desc2 = f"HEATER {ab}, SHELL, {d}X{h}, {material}"
    rows.append({'description': desc2, 'product_type': 'Raw Material'})
    
    # Excel formula: =IF(I14=0,CONCATENATE("HEATER, STACK, ",I6,"X",I16,", W/",I7,"FL"),CONCATENATE("HEATER ",I14,", STACK, ",I6,"X",I16,", W/",I7,"FL"))
    if not ab:
        desc3 = f"HEATER, STACK, {sd}X{sh}, W/{fi}FL"
    else:
        desc3 = f"HEATER {ab}, STACK, {sd}X{sh}, W/{fi}FL"
    rows.append({'description': desc3, 'product_type': 'Raw Material'})
    
    # Excel formula: =IF(I14=0,CONCATENATE("GAS TRAIN, ",I10,", ",I11,", ","SIEMENS",", ",I12,"MBTU, ",I13),CONCATENATE("GAS TRAIN, HTR ",I14, ", ",I10,", ",I11,", ","SIEMENS",", ",I12,"MBTU, ",I13))
    if not ab:
        desc4 = f"GAS TRAIN, {gts}, {mount}, SIEMENS, {btu}MBTU, {hand}"
    else:
        desc4 = f"GAS TRAIN, HTR {ab}, {gts}, {mount}, SIEMENS, {btu}MBTU, {hand}"
    rows.append({'description': desc4, 'product_type': 'Pegged Supply'})
    
    # Excel formula: =IF(I15="SINGLE",I17,I18)
    # This should be a proper description, not just the ab value
    if heater.heater_single_dual == 'SINGLE':
        mod_piping_desc = f"HEATER, MOD PIPING, {model}"
    else:
        mod_piping_desc = f"HEATER, MOD PIPING, {model}"
    rows.append({'description': mod_piping_desc, 'product_type': 'Raw Material'})
    
    # Excel formula: =IF(I14=0,CONCATENATE("PRECUT HTR",I4,", ",I6,"STACK, 11GA, ",I9),CONCATENATE("PRECUT HTR",I14,I4,", ",I6,"STACK, 11GA, ",I9))
    if not ab:
        precut_desc = f"PRECUT HTR{d}, {sd}STACK, 11GA, {material}"
    else:
        precut_desc = f"PRECUT HTR{ab}{d}, {sd}STACK, 11GA, {material}"
    rows.append({'description': precut_desc, 'product_type': 'Raw Material', 'override_suffix': 'A'})
    
    return rows


def _build_tank_rows(tank: D365Tank) -> list[dict]:
    d = _fmt_dim(tank.tank_diameter)
    h = _fmt_dim(tank.tank_height)
    material = (tank.material or '').upper()
    ttype = (tank.tank_type or '').upper()
    ti = _fmt_dim(tank.tank_inches)
    
    rows: list[dict] = []
    
    # Excel formula: =CONCATENATE("TANK, ",H4,"X",H5,", ",H7,", ",H6)
    rows.append({'description': f"TANK, {d}X{h}, {ttype}, {material}", 'product_type': 'Finished Good'})
    
    # Excel formula: =CONCATENATE("TANK, SHELL, ",H4,"X",H8,", ",H6)
    rows.append({'description': f"TANK, SHELL, {d}X{ti}, {material}", 'product_type': 'Raw Material'})
    
    # Excel formula: =CONCATENATE("PRECUT TANK",H4,"X",H5,", 11GA, ",H6)
    rows.append({'description': f"PRECUT TANK{d}X{h}, 11GA, {material}", 'product_type': 'Raw Material', 'override_suffix': 'A'})
    
    return rows


def _build_pump_rows(pump: D365Pump) -> list[dict]:
    ptype = (pump.pump_type or '').upper()
    ppress = (pump.pump_pressure or '').upper()
    stype = (pump.system_type or '').upper()
    hp = _fmt_dim(pump.hp)
    material = (pump.material or '').upper()
    sl = _fmt_dim(pump.skid_length)
    sw = _fmt_dim(pump.skid_width)
    sh = _fmt_dim(pump.skid_height)
    
    rows: list[dict] = []
    
    # Excel formula: =IF(G4="LP",CONCATENATE("PUMP, ",G3,", ",G5,", ",G6,"HP"),CONCATENATE("PUMP, ",G3,", ",G4,", ",G5,", ",G6,"HP"))
    if ppress == "LP":
        pump_desc = f"PUMP, {ptype}, {stype}, {hp}HP"
    else:
        pump_desc = f"PUMP, {ptype}, {ppress}, {stype}, {hp}HP"
    rows.append({'description': pump_desc, 'product_type': 'Finished Good'})
    
    # Excel formula: =CONCATENATE("PUMP SKID, ",G3,", ",G8,"X",G9,"X",G10,", ",G7)
    rows.append({'description': f"PUMP SKID, {ptype}, {sl}X{sw}X{sh}, {material}", 'product_type': 'Raw Material'})
    
    # Excel formula: =IF(G3="SIMPLEX",CONCATENATE("PRECUT, ",G3," PUMP SKID",","," 11GA"),CONCATENATE("PRECUT, ",G3," PUMP SKID",","," 3/16PL"))
    if ptype == "SIMPLEX":
        precut_desc = f"PRECUT, {ptype} PUMP SKID, 11GA"
    else:
        precut_desc = f"PRECUT, {ptype} PUMP SKID, 3/16PL"
    rows.append({'description': precut_desc, 'product_type': 'Raw Material', 'override_suffix': 'A'})
    
    return rows

# Create your views here.

```

### d365\urls.py
```python
from django.urls import path
from . import views

urlpatterns = [
    path('', views.d365_home, name='d365_home'),
    path('generate-all/', views.generate_all, name='d365_generate_all'),
    path('generate-selected/', views.generate_selected, name='d365_generate_selected'),
    path('save-selection/', views.save_selection, name='d365_save_selection'),
    path('generate/heater/', views.generate_heater, name='d365_generate_heater'),
    path('generate/tank/', views.generate_tank, name='d365_generate_tank'),
    path('generate/pump/', views.generate_pump, name='d365_generate_pump'),
    path('excel-preview/', views.excel_preview, name='d365_excel_preview'),
    path('delete-job/<int:job_id>/', views.delete_job, name='d365_delete_job'),
    path('save-job/', views.save_job, name='d365_save_job'),
    path('load-job/<int:job_id>/', views.load_job_by_id, name='d365_load_job_by_id'),
    path('load-job-number/<str:job_number>/', views.load_job_by_number, name='d365_load_job_by_number'),
    path('jobs/', views.jobs_list, name='d365_jobs_list'),
    path('print/<str:job_number>/', views.print_job, name='d365_print_job'),
]



```

### d365\admin.py
```python
from django.contrib import admin
from import_export import admin as import_export_admin
from . import models
from .resources import (
    D365JobResource, D365HeaterResource, D365TankResource, D365PumpResource,
    D365GeneratedItemResource, HeaterMaterialResource, HeaterDiameterResource,
    HeaterHeightResource, StackDiameterResource, StackHeightResource,
    FlangeInletResource, HeaterModelRefResource, GasTrainSizeResource,
    GasTrainMountResource, BTURatingResource, HeaterHandRefResource,
    TankMaterialResource, HeaterABRefResource, TankDiameterResource,
    TankHeightResource, TankHeightInchesResource, TankTypeResource,
    PumpMaterialResource, PumpTypeRefResource, PumpPressureResource,
    SystemTypeResource, HorsepowerResource
)


@admin.register(models.D365Job)
class D365JobAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = D365JobResource
    list_display = ('job_number', 'job_name', 'updated_at')
    search_fields = ('job_number', 'job_name')
    list_filter = ('created_at', 'updated_at')


@admin.register(models.D365Heater)
class D365HeaterAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = D365HeaterResource
    list_display = ('job_number', 'dash_number', 'material', 'heater_diameter', 'heater_height')
    search_fields = ('job_number',)
    list_filter = ('material', 'heater_diameter', 'heater_height', 'created_at')
    date_hierarchy = 'created_at'


@admin.register(models.D365Tank)
class D365TankAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = D365TankResource
    list_display = ('job_number', 'dash_number', 'material', 'tank_diameter', 'tank_height')
    search_fields = ('job_number',)
    list_filter = ('material', 'tank_type', 'tank_diameter', 'created_at')
    date_hierarchy = 'created_at'


@admin.register(models.D365Pump)
class D365PumpAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = D365PumpResource
    list_display = ('job_number', 'dash_number', 'pump_type', 'hp', 'material')
    search_fields = ('job_number',)
    list_filter = ('pump_type', 'pump_pressure', 'system_type', 'created_at')
    date_hierarchy = 'created_at'


@admin.register(models.D365GeneratedItem)
class D365GeneratedItemAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = D365GeneratedItemResource
    list_display = ('job_number', 'section', 'item_number', 'description', 'created_at')
    search_fields = ('job_number', 'item_number', 'description')
    list_filter = ('section', 'bom', 'template', 'product_type', 'created_at')
    date_hierarchy = 'created_at'
    ordering = ('-created_at',)


# Reference models with import/export
@admin.register(models.HeaterMaterial)
class HeaterMaterialAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = HeaterMaterialResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.HeaterDiameter)
class HeaterDiameterAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = HeaterDiameterResource
    list_display = ('diameter_inch',)
    search_fields = ('diameter_inch',)


@admin.register(models.HeaterHeight)
class HeaterHeightAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = HeaterHeightResource
    list_display = ('height_ft',)
    search_fields = ('height_ft',)


@admin.register(models.StackDiameter)
class StackDiameterAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = StackDiameterResource
    list_display = ('diameter_inch',)
    search_fields = ('diameter_inch',)


@admin.register(models.StackHeight)
class StackHeightAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = StackHeightResource
    list_display = ('height_ft',)
    search_fields = ('height_ft',)


@admin.register(models.FlangeInlet)
class FlangeInletAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = FlangeInletResource
    list_display = ('size_inch',)
    search_fields = ('size_inch',)


@admin.register(models.HeaterModelRef)
class HeaterModelRefAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = HeaterModelRefResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.GasTrainSize)
class GasTrainSizeAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = GasTrainSizeResource
    list_display = ('size_inch',)
    search_fields = ('size_inch',)


@admin.register(models.GasTrainMount)
class GasTrainMountAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = GasTrainMountResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.BTURating)
class BTURatingAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = BTURatingResource
    list_display = ('value_mmbtu',)
    search_fields = ('value_mmbtu',)


@admin.register(models.HeaterHandRef)
class HeaterHandRefAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = HeaterHandRefResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.TankMaterial)
class TankMaterialAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = TankMaterialResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.HeaterABRef)
class HeaterABRefAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = HeaterABRefResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.TankDiameter)
class TankDiameterAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = TankDiameterResource
    list_display = ('diameter_inch',)
    search_fields = ('diameter_inch',)


@admin.register(models.TankHeight)
class TankHeightAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = TankHeightResource
    list_display = ('height_ft',)
    search_fields = ('height_ft',)


@admin.register(models.TankHeightInches)
class TankHeightInchesAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = TankHeightInchesResource
    list_display = ('height_ft', 'inches')
    search_fields = ('height_ft', 'inches')


@admin.register(models.TankType)
class TankTypeAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = TankTypeResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.PumpMaterial)
class PumpMaterialAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = PumpMaterialResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.PumpTypeRef)
class PumpTypeRefAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = PumpTypeRefResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.PumpPressure)
class PumpPressureAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = PumpPressureResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.SystemType)
class SystemTypeAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = SystemTypeResource
    list_display = ('code', 'display_name')
    search_fields = ('code', 'display_name')


@admin.register(models.Horsepower)
class HorsepowerAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = HorsepowerResource
    list_display = ('hp',)
    search_fields = ('hp',)

# Register your models here.

```

### d365\apps.py
```python
from django.apps import AppConfig


class D365Config(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'd365'

```

### d365\tests.py
```python
from django.test import TestCase

# Create your tests here.

```

### App: dynamics_search
### dynamics_search\models.py
```python
from django.db import models
from django.db.models import F, Value
from django.db.models.functions import Concat
from django.conf import settings

# Import PostgreSQL features only if using PostgreSQL
try:
    from django.contrib.postgres.indexes import GinIndex
    from django.contrib.postgres.search import SearchVectorField
    POSTGRES_AVAILABLE = True
except ImportError:
    POSTGRES_AVAILABLE = False


class Part(models.Model):
    id = models.AutoField(primary_key=True)
    item_number = models.CharField(max_length=50, unique=True)
    description = models.TextField(blank=True)
    size = models.CharField(max_length=20, blank=True)
    product_group_id = models.CharField(max_length=50, blank=True)
    unit_cost = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    unit_cost_date = models.DateTimeField(null=True, blank=True)
    vendor_name = models.CharField(max_length=255, blank=True)
    vendor_product_number = models.CharField(max_length=100, blank=True)
    vendor_product_description = models.TextField(blank=True)
    vendor_phone = models.CharField(max_length=20, blank=True)
    last_updated = models.DateTimeField(auto_now=True)
    
    # Full-text search vector field (PostgreSQL only)
    search_vector = models.TextField(null=True, blank=True) if not POSTGRES_AVAILABLE else SearchVectorField(null=True, blank=True)
    
    class Meta:
        ordering = ['item_number']
        indexes = [
            # Regular indexes for common lookups
            models.Index(fields=['item_number']),
            models.Index(fields=['last_updated']),
        ]
        
        # Add PostgreSQL-specific indexes if available
        if POSTGRES_AVAILABLE and 'postgresql' in settings.DATABASES['default']['ENGINE']:
            indexes.append(GinIndex(fields=['search_vector']))
    
    def __str__(self):
        return f"{self.item_number} - {self.description[:50] if self.description else 'No Description'}"
    
    def save(self, *args, **kwargs):
        # Update search vector when saving
        search_parts = []
        if self.item_number:
            search_parts.append(str(self.item_number))
        if self.description:
            search_parts.append(str(self.description))
        if self.size:
            search_parts.append(str(self.size))
        if self.product_group_id:
            search_parts.append(str(self.product_group_id))
        if self.vendor_name:
            search_parts.append(str(self.vendor_name))
        if self.vendor_product_number:
            search_parts.append(str(self.vendor_product_number))
        if self.vendor_product_description:
            search_parts.append(str(self.vendor_product_description))
        
        self.search_vector = ' '.join(search_parts)
        super().save(*args, **kwargs)
    
    @property
    def content_hash(self):
        """Generate hash for change detection"""
        import hashlib
        content = f"{self.description}|{self.size}|{self.product_group_id}|{self.unit_cost}|{self.vendor_name}|{self.vendor_product_number}|{self.vendor_product_description}"
        return hashlib.md5(content.encode()).hexdigest()
```

### dynamics_search\views.py
```python
from django.shortcuts import render
from django.http import JsonResponse
from django.db.models import Q, F
from django.core.paginator import Paginator
from django.views.decorators.http import require_http_methods
from django.views.decorators.csrf import csrf_exempt
from django.conf import settings
import json
import re

from .models import Part

# Import PostgreSQL features only if using PostgreSQL
try:
    from django.contrib.postgres.search import TrigramSimilarity, SearchQuery, SearchRank
    POSTGRES_AVAILABLE = True
except ImportError:
    POSTGRES_AVAILABLE = False


def search_page(request):
    """Main search page with HTMX-powered live search"""
    return render(request, 'dynamics_search/search.html')


@require_http_methods(["GET"])
def search_api(request):
    """API endpoint for part search with trigram and wildcard support"""
    query = request.GET.get('q', '').strip()
    columns = request.GET.getlist('columns')  # Get list of selected columns
    
    if not query:
        return JsonResponse({
            'results': [],
            'total': 0,
            'query': query
        })
    
    # Parse wildcards and build search conditions based on selected columns
    search_conditions = build_search_conditions(query, columns)
    
    # Base queryset
    queryset = Part.objects.all()
    
    # Apply search conditions
    if search_conditions:
        queryset = queryset.filter(search_conditions)
    
    # Add similarity ranking (PostgreSQL trigram or basic SQLite)
    if POSTGRES_AVAILABLE and 'postgresql' in settings.DATABASES['default']['ENGINE']:
        # Use PostgreSQL trigram similarity based on selected columns
        similarity_conditions = []
        if not columns or 'item_number' in columns:
            similarity_conditions.append(TrigramSimilarity('item_number', query))
        if not columns or 'description' in columns:
            similarity_conditions.append(TrigramSimilarity('description', query))
        if not columns or 'size' in columns:
            similarity_conditions.append(TrigramSimilarity('size', query))
        if not columns or 'vendor_name' in columns:
            similarity_conditions.append(TrigramSimilarity('vendor_name', query))
        
        if similarity_conditions:
            queryset = queryset.annotate(similarity=sum(similarity_conditions)).order_by('-similarity', 'item_number')
        else:
            queryset = queryset.order_by('item_number')
    else:
        # Basic SQLite similarity based on contains matches
        similarity_case = "CASE "
        params = []
        
        if not columns or 'item_number' in columns:
            similarity_case += "WHEN item_number LIKE %s THEN 4 "
            params.append(f'%{query}%')
        if not columns or 'description' in columns:
            similarity_case += "WHEN description LIKE %s THEN 3 "
            params.append(f'%{query}%')
        if not columns or 'size' in columns:
            similarity_case += "WHEN size LIKE %s THEN 2 "
            params.append(f'%{query}%')
        if not columns or 'vendor_name' in columns:
            similarity_case += "WHEN vendor_name LIKE %s THEN 1 "
            params.append(f'%{query}%')
        
        similarity_case += "ELSE 0 END"
        
        queryset = queryset.extra(
            select={'similarity': similarity_case},
            select_params=params
        ).order_by('-similarity', 'item_number')
    
    # Pagination
    page = int(request.GET.get('page', 1))
    per_page = int(request.GET.get('per_page', 20))
    
    paginator = Paginator(queryset, per_page)
    page_obj = paginator.get_page(page)
    
    # Format results
    results = []
    for part in page_obj:
        results.append({
            'id': part.id,
            'item_number': part.item_number,
            'description': part.description,
            'size': part.size,
            'product_group_id': part.product_group_id,
            'unit_cost': float(part.unit_cost) if part.unit_cost else None,
            'unit_cost_date': part.unit_cost_date.isoformat() if part.unit_cost_date else None,
            'vendor_name': part.vendor_name,
            'vendor_product_number': part.vendor_product_number,
            'vendor_product_description': part.vendor_product_description,
            'vendor_phone': part.vendor_phone,
            'similarity': round(part.similarity, 3) if hasattr(part, 'similarity') else 0,
            'last_updated': part.last_updated.isoformat()
        })
    
    # Check if this is an HTMX request
    if request.headers.get('HX-Request'):
        # Return HTML for HTMX
        context = {
            'results': results,
            'total': paginator.count,
            'page': page,
            'per_page': per_page,
            'total_pages': paginator.num_pages,
            'has_next': page_obj.has_next(),
            'has_previous': page_obj.has_previous(),
            'query': query
        }
        return render(request, 'dynamics_search/search_results.html', context)
    else:
        # Return JSON for AJAX requests
        return JsonResponse({
            'results': results,
            'total': paginator.count,
            'page': page,
            'per_page': per_page,
            'total_pages': paginator.num_pages,
            'has_next': page_obj.has_next(),
            'has_previous': page_obj.has_previous(),
            'query': query
        })


def build_search_conditions(query, columns=None):
    """Build Q objects for search with wildcard support and column filtering"""
    conditions = Q()
    
    # Clean up the query - remove wildcard characters and split by spaces
    clean_query = query.replace('%', '').replace('*', '').strip()
    
    if not clean_query:
        return Q()  # Return empty Q if no valid search terms
    
    # Split by spaces for multiple terms
    terms = clean_query.split()
    
    # Define available search fields
    search_fields = {
        'item_number': Q(item_number__icontains=''),
        'description': Q(description__icontains=''),
        'size': Q(size__icontains=''),
        'vendor_name': Q(vendor_name__icontains='')
    }
    
    # If no columns specified, search all fields (default behavior)
    if not columns:
        columns = list(search_fields.keys())
    
    for term in terms:
        if term:  # Only process non-empty terms
            term_conditions = Q()
            
            # Build conditions for each selected column
            for column in columns:
                if column in search_fields:
                    if column == 'item_number':
                        term_conditions |= Q(item_number__icontains=term)
                    elif column == 'description':
                        term_conditions |= Q(description__icontains=term)
                    elif column == 'size':
                        term_conditions |= Q(size__icontains=term)
                    elif column == 'vendor_name':
                        term_conditions |= Q(vendor_name__icontains=term)
            
            # Add this term's conditions to the overall conditions
            if term_conditions:
                conditions &= term_conditions
    
    return conditions


@require_http_methods(["GET"])
def search_suggestions(request):
    """Get search suggestions for autocomplete"""
    query = request.GET.get('q', '').strip()
    
    if len(query) < 2:
        return JsonResponse({'suggestions': []})
    
    # Get suggestions from item_number and description
    suggestions = Part.objects.filter(
        Q(item_number__icontains=query) | 
        Q(description__icontains=query)
    ).values_list('item_number', 'description')[:10]
    
    # Format suggestions
    results = []
    seen = set()
    
    for item_number, description in suggestions:
        if item_number not in seen:
            results.append({
                'item_number': item_number,
                'description': description[:100] + '...' if len(description) > 100 else description
            })
            seen.add(item_number)
    
    return JsonResponse({'suggestions': results})


def part_detail(request, part_id):
    """Detail view for a specific part"""
    try:
        part = Part.objects.get(id=part_id)
        return render(request, 'dynamics_search/part_detail.html', {'part': part})
    except Part.DoesNotExist:
        return JsonResponse({'error': 'Part not found'}, status=404)
```

### dynamics_search\urls.py
```python
from django.urls import path
from . import views

app_name = 'dynamics_search'

urlpatterns = [
    path('', views.search_page, name='search'),
    path('api/', views.search_api, name='search_api'),
    path('suggestions/', views.search_suggestions, name='search_suggestions'),
    path('part/<int:part_id>/', views.part_detail, name='part_detail'),
]

```

### dynamics_search\admin.py
```python
from django.contrib import admin
from django.utils.html import format_html
from import_export import admin as import_export_admin
from .models import Part
from .resources import PartResource


@admin.register(Part)
class PartAdmin(import_export_admin.ImportExportModelAdmin):
    resource_class = PartResource
    list_display = ['item_number', 'description_short', 'size', 'product_group_id', 'unit_cost', 'vendor_name', 'last_updated']
    list_filter = ['last_updated', 'size', 'product_group_id', 'vendor_name']
    search_fields = ['item_number', 'description', 'size', 'product_group_id', 'vendor_name', 'vendor_product_number']
    readonly_fields = ['last_updated', 'content_hash', 'search_vector']
    ordering = ['-last_updated']
    
    fieldsets = (
        ('Basic Information', {
            'fields': ('item_number', 'description', 'size', 'product_group_id')
        }),
        ('Cost Information', {
            'fields': ('unit_cost', 'unit_cost_date'),
            'classes': ('collapse',)
        }),
        ('Vendor Information', {
            'fields': ('vendor_name', 'vendor_product_number', 'vendor_product_description', 'vendor_phone'),
            'classes': ('collapse',)
        }),
        ('System Information', {
            'fields': ('last_updated', 'content_hash', 'search_vector'),
            'classes': ('collapse',)
        }),
    )
    
    def description_short(self, obj):
        """Display truncated description"""
        if len(obj.description) > 50:
            return f"{obj.description[:50]}..."
        return obj.description
    description_short.short_description = 'Description'
    
    def similarity_score(self, obj):
        """Display similarity score if available"""
        if hasattr(obj, 'similarity'):
            score = int(obj.similarity * 100)
            color = 'green' if score > 80 else 'orange' if score > 50 else 'red'
            return format_html(
                '<span style="color: {};">{}%</span>',
                color, score
            )
        return '-'
    similarity_score.short_description = 'Similarity'
    
    def get_queryset(self, request):
        """Optimize queryset for admin"""
        return super().get_queryset(request).select_related()
    
    actions = ['refresh_search_vectors']
    
    def refresh_search_vectors(self, request, queryset):
        """Refresh search vectors for selected parts"""
        updated = 0
        for part in queryset:
            part.save()  # This will update the search_vector
            updated += 1
        
        self.message_user(
            request,
            f"Successfully refreshed search vectors for {updated} parts."
        )
    refresh_search_vectors.short_description = "Refresh search vectors"
```

### dynamics_search\apps.py
```python
from django.apps import AppConfig


class DynamicsSearchConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'dynamics_search'

```

### dynamics_search\tests.py
```python
from django.test import TestCase

# Create your tests here.

```

#### Templates in dynamics_search
### dynamics_search\templates\dynamics_search\part_detail.html
```python
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ part.item_number }} - Part Details - Kemco Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="min-h-screen bg-base-200">
    {% include 'includes/navbar.html' %}
<div class="container mx-auto px-4 py-8">
    <!-- Back Button -->
    <div class="mb-6">
        <button onclick="history.back()" class="btn btn-ghost">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Search
        </button>
    </div>

    <!-- Part Details Card -->
    <div class="max-w-4xl mx-auto">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-primary mb-2">{{ part.item_number }}</h1>
                        <p class="text-base-content/70">Part Details</p>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="copyToClipboard('{{ part.item_number }}')"
                            class="btn btn-outline btn-sm"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy Item Number
                        </button>
                    </div>
                </div>

                <!-- Part Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-semibold text-base-content/70 uppercase tracking-wide">Item Number</label>
                            <p class="text-lg font-mono bg-base-200 p-3 rounded">{{ part.item_number }}</p>
                        </div>
                        
                        {% if part.size %}
                        <div>
                            <label class="text-sm font-semibold text-base-content/70 uppercase tracking-wide">Size</label>
                            <p class="text-lg bg-base-200 p-3 rounded">{{ part.size }}</p>
                        </div>
                        {% endif %}
                        
                        <div>
                            <label class="text-sm font-semibold text-base-content/70 uppercase tracking-wide">Last Updated</label>
                            <p class="text-lg bg-base-200 p-3 rounded">{{ part.last_updated|date:"F d, Y \a\t g:i A" }}</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-sm font-semibold text-base-content/70 uppercase tracking-wide">Description</label>
                        <div class="bg-base-200 p-4 rounded-lg">
                            <p class="text-base whitespace-pre-wrap">{{ part.description }}</p>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="divider"></div>
                <div class="flex justify-between items-center">
                    <div class="text-sm text-base-content/60">
                        Part ID: {{ part.id }}
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="searchSimilar('{{ part.item_number }}')"
                            class="btn btn-outline btn-sm"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Find Similar
                        </button>
                        <button 
                            onclick="window.print()"
                            class="btn btn-outline btn-sm"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                            </svg>
                            Print
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show success toast
        const toast = document.createElement('div');
        toast.className = 'toast toast-top toast-end';
        toast.innerHTML = `
            <div class="alert alert-success">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span>Copied to clipboard!</span>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    });
}

function searchSimilar(itemNumber) {
    // Navigate back to search with the item number as query
    window.location.href = `/search/?q=${encodeURIComponent(itemNumber)}`;
}
</script>

<style>
@media print {
    .btn, .divider {
        display: none !important;
    }
    
    .card {
        box-shadow: none !important;
        border: 1px solid #ccc !important;
    }
}
</style>
</body>
</html>

```

### dynamics_search\templates\dynamics_search\search.html
```python
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parts Search - Kemco Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="min-h-screen bg-base-200">
    {% include 'includes/navbar.html' %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-base-content mb-4">Parts Search</h1>
        <p class="text-lg text-base-content/70">Search and discover parts from Dynamics 365</p>
    </div>

    <!-- Search Form -->
    <div class="max-w-4xl mx-auto mb-8">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <!-- Search Column Filters -->
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text text-lg font-semibold">Search In Columns</span>
                    </label>
                    <div class="flex flex-wrap gap-2">
                        <button 
                            class="btn btn-outline btn-sm search-filter-btn" 
                            data-column="item_number"
                            onclick="toggleSearchFilter(this)"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                            </svg>
                            Item Number
                        </button>
                        <button 
                            class="btn btn-outline btn-sm search-filter-btn" 
                            data-column="description"
                            onclick="toggleSearchFilter(this)"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Description
                        </button>
                        <button 
                            class="btn btn-outline btn-sm search-filter-btn" 
                            data-column="size"
                            onclick="toggleSearchFilter(this)"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                            </svg>
                            Size
                        </button>
                        <button 
                            class="btn btn-outline btn-sm search-filter-btn" 
                            data-column="vendor_name"
                            onclick="toggleSearchFilter(this)"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            Vendor Name
                        </button>
                        <button 
                            class="btn btn-ghost btn-sm" 
                            onclick="clearAllFilters()"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Clear All
                        </button>
                    </div>
                    <div class="label">
                        <span class="label-text-alt">Select columns to search in. If none selected, searches all columns.</span>
                    </div>
                </div>

                <!-- Search Input -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text text-lg font-semibold">Search Parts</span>
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search-input"
                            placeholder="Enter search term or use wildcards (e.g., %hose%, *valve*)"
                            class="input input-bordered input-lg w-full pr-12"
                            hx-get="{% url 'dynamics_search:search_api' %}"
                            hx-trigger="keyup changed delay:300ms"
                            hx-target="#search-results"
                            hx-indicator="#search-spinner"
                            name="q"
                        />
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <div id="search-spinner" class="loading loading-spinner loading-sm htmx-indicator"></div>
                        </div>
                    </div>
                    <div class="label">
                        <span class="label-text-alt">Use % for wildcards (e.g., %hose% finds all parts containing 'hose')</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div id="search-results" class="max-w-6xl mx-auto">
        <!-- Initial empty state -->
        <div class="text-center py-12">
            <div class="text-6xl mb-4"></div>
            <h3 class="text-xl font-semibold text-base-content/70 mb-2">Start searching for parts</h3>
            <p class="text-base-content/50">Enter a part number, description, or use wildcards to find what you're looking for</p>
        </div>
    </div>
</div>

<script>
// Global variables for search state
let activeFilters = new Set();

// Initialize search input focus
document.addEventListener('DOMContentLoaded', function() {
    console.log('Search page loaded');
    document.getElementById('search-input').focus();
    
    // Test HTMX is working
    if (typeof htmx !== 'undefined') {
        console.log('HTMX is loaded');
    } else {
        console.error('HTMX is not loaded');
    }
    
    // Update search input to include filter parameters
    updateSearchInput();
});

// Toggle search filter button
function toggleSearchFilter(button) {
    const column = button.getAttribute('data-column');
    
    if (activeFilters.has(column)) {
        // Remove filter
        activeFilters.delete(column);
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline');
    } else {
        // Add filter
        activeFilters.add(column);
        button.classList.remove('btn-outline');
        button.classList.add('btn-primary');
    }
    
    // Update search input with new filters
    updateSearchInput();
    
    // Trigger search if there's a query
    const searchInput = document.getElementById('search-input');
    if (searchInput.value.trim()) {
        searchInput.dispatchEvent(new Event('keyup'));
    }
}

// Clear all filters
function clearAllFilters() {
    activeFilters.clear();
    
    // Update all filter buttons
    document.querySelectorAll('.search-filter-btn').forEach(button => {
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline');
    });
    
    // Update search input
    updateSearchInput();
    
    // Trigger search if there's a query
    const searchInput = document.getElementById('search-input');
    if (searchInput.value.trim()) {
        searchInput.dispatchEvent(new Event('keyup'));
    }
}

// Update search input to include filter parameters
function updateSearchInput() {
    const searchInput = document.getElementById('search-input');
    let url = searchInput.getAttribute('hx-get');
    
    // Remove existing filter parameters
    url = url.split('?')[0];
    
    // Add filter parameters if any are active
    if (activeFilters.size > 0) {
        const filterParams = Array.from(activeFilters).map(filter => `columns=${filter}`).join('&');
        url += `?${filterParams}`;
    }
    
    searchInput.setAttribute('hx-get', url);
}

// Override HTMX request to include current query
document.body.addEventListener('htmx:beforeRequest', function(event) {
    const searchInput = document.getElementById('search-input');
    const query = searchInput.value.trim();
    
    if (query) {
        const url = new URL(event.detail.xhr.url);
        url.searchParams.set('q', query);
        event.detail.xhr.url = url.toString();
    }
});
</script>
</body>
</html>

```

### dynamics_search\templates\dynamics_search\search_results.html
```python
<!-- Search Results -->
<div class="max-w-6xl mx-auto">
    <!-- Results Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-base-content">
                Search Results
                <span class="badge badge-primary badge-lg ml-2">{{ total }}</span>
            </h2>
            <p class="text-base-content/70">Searching for: "{{ query }}"</p>
        </div>
        <div class="flex gap-2">
            <button 
                id="export-btn"
                class="btn btn-outline btn-sm"
                onclick="exportResults()"
            >
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Export
            </button>
        </div>
    </div>

    <!-- Results List -->
    <div id="results-list" class="space-y-4">
        {% for part in results %}
        <div class="collapse collapse-arrow bg-base-100 shadow-md hover:shadow-lg transition-shadow mb-2">
            <input type="checkbox" class="collapse-toggle" />
            <div class="collapse-title">
                <div class="flex justify-between items-center">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <h3 class="text-lg font-bold text-primary">{{ part.item_number }}</h3>
                            <div class="badge badge-outline">{{ part.similarity|floatformat:0 }}% match</div>
                        </div>
                        <p class="text-base-content/80 mt-1">{{ part.description|default:"No description" }}</p>
                    </div>
                    <div class="text-sm text-base-content/60">{{ part.size|default:"No size" }}</div>
                </div>
            </div>
            <div class="collapse-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Item Number</span>
                        </label>
                        <div class="text-sm">{{ part.item_number }}</div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Description</span>
                        </label>
                        <div class="text-sm">{{ part.description|default:"No description" }}</div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Size</span>
                        </label>
                        <div class="text-sm">{{ part.size|default:"No size" }}</div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Vendor Name</span>
                        </label>
                        <div class="text-sm">{{ part.vendor_name|default:"N/A" }}</div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Unit Cost</span>
                        </label>
                        <div class="text-sm">
                            {% if part.unit_cost %}
                                ${{ part.unit_cost|floatformat:2 }}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Last Updated</span>
                        </label>
                        <div class="text-sm">{{ part.last_updated|date:"M d, Y" }}</div>
                    </div>
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Similarity Score</span>
                        </label>
                        <div class="text-sm">{{ part.similarity|floatformat:0 }}% match</div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 p-4 border-t">
                    <button 
                        class="btn btn-ghost btn-sm"
                        onclick="copyToClipboard('{{ part.item_number }}')"
                    >
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                        Copy Item Number
                    </button>
                    <button 
                        class="btn btn-primary btn-sm"
                        onclick="viewDetails({{ part.id }})"
                    >
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                        </svg>
                        View Full Details
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="flex justify-center mt-8">
        <div class="join">
            {% if has_previous %}
                <button class="join-item btn btn-outline" onclick="searchPage({{ page|add:"-1" }})">Previous</button>
            {% endif %}
            
            <span class="join-item btn btn-active">{{ page }} of {{ total_pages }}</span>
            
            {% if has_next %}
                <button class="join-item btn btn-outline" onclick="searchPage({{ page|add:"1" }})">Next</button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- No Results -->
    {% if total == 0 %}
    <div class="text-center py-12">
        <div class="text-6xl mb-4"></div>
        <h3 class="text-xl font-semibold text-base-content/70 mb-2">No parts found</h3>
        <p class="text-base-content/50">Try adjusting your search terms or using wildcards</p>
    </div>
    {% endif %}
</div>

<script>
// Store current results for export functionality
window.currentResults = {{ results|safe }};
window.currentQuery = "{{ query }}";

// Copy to clipboard function
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show success feedback
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Copied!';
        button.classList.add('btn-success');
        button.classList.remove('btn-ghost');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-ghost');
        }, 2000);
    });
}

// View details function
function viewDetails(partId) {
    window.open(`/search/part/${partId}/`, '_blank');
}

// Export results function
function exportResults() {
    if (!window.currentResults || window.currentResults.length === 0) return;
    
    const csvContent = [
        ['Item Number', 'Description', 'Size', 'Vendor', 'Cost', 'Last Updated', 'Similarity'],
        ...window.currentResults.map(part => [
            part.item_number,
            part.description || '',
            part.size || '',
            part.vendor_name || '',
            part.unit_cost ? `$${parseFloat(part.unit_cost).toFixed(2)}` : '',
            new Date(part.last_updated).toLocaleDateString(),
            `${Math.round(part.similarity * 100)}%`
        ])
    ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `parts_search_${window.currentQuery.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Search page function for pagination
function searchPage(page) {
    const searchInput = document.getElementById('search-input');
    const currentQuery = searchInput.value;
    const url = new URL(window.location.origin + '/search/api/');
    url.searchParams.set('q', currentQuery);
    url.searchParams.set('page', page);
    
    fetch(url)
        .then(response => response.text())
        .then(html => {
            document.getElementById('search-results').innerHTML = html;
        });
}
</script>

```

